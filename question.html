<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RMP MOCK TEST</title>
  <style>
    body { background:#f4f4f4; font-size:15px; }
    .container{
      max-width:820px; margin:36px auto; background:#fff; border-radius:18px;
      box-shadow:0 6px 32px rgba(0,0,0,0.08);
      padding:18px 18px 20px 18px;
    }
    .icon-main{ text-align:center; margin-bottom:10px; }
    .icon-main svg{ vertical-align:middle; width:34px; height:34px; margin-right:6px; }
    .icon-main span{ font-size:1.1em; vertical-align:middle; }
    .title{ font-size:1.23em; font-weight:bold; margin-bottom:12px; text-align:center; letter-spacing:0.01em; }

    .question-header-row{ display:flex; align-items:center; justify-content:center; gap:18px; margin:18px 0 10px 0; }
    .question-big{ font-size:1.09em; font-weight:bold; color:#1976d2; }
    .level-tag{ font-size:1em; font-weight:bold; border-radius:5px; padding:5px 13px; margin-left:8px; }
    .level-Easy{ background:#43a047; color:#fff; }
    .level-Moderate{ background:#fbc02d; color:#fff; }
    .level-Difficult{ background:#d32f2f; color:#fff; }
    .level-Expert{ background:#8e24aa; color:#fff; }

    /* ===== TIMER ===== */
    #timer-controls {
      margin: 0 auto 16px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap:7px;
      background: #f9f6ef;
      border-radius: 8px;
      padding: 7px 12px;
      box-shadow: 0 1.5px 4px rgba(255,193,7,0.07);
      max-width: 520px;
      font-size: 1em;
    }
    #timer-sandglass {
      font-size:1.28em;
      margin:0 3px 0 0;
      color: #ff9800;
      animation: sandmove 2s infinite linear;
      display:inline-block;
    }
    @keyframes sandmove {
      0%   {transform:rotate(0deg);}
      90%  {transform:rotate(0deg);}
      100% {transform:rotate(180deg);}
    }
    #timer-controls label {font-weight:500; margin:0;}
    #timer-controls input[type="number"]{
      width:30px;
      border-radius:3px;
      border:1px solid #ccc;
      font-size:1em;
      padding:1px 2px;
      margin:0 0 0 3px;
    }
    #start-timer, #reset-timer{
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 5px 13px;
      font-weight: bold;
      font-size: 0.97em;
      cursor:pointer;
      transition:background 0.16s;
      margin-left: 0;
    }
    #start-timer:hover, #reset-timer:hover { background: #0d47a1; }
    #reset-timer { background:#bbb; color:#222; }
    #timer-display { font-size:1.09em; margin-left:3px; font-weight:bold; color:#1976d2; }

    /* ===== Top tools buttons (Summary + Hint) ===== */
    .top-tools-row{
      display:flex;
      gap:14px;
      justify-content:flex-start;
      align-items:center;
      margin:6px 0 10px 0;
      flex-wrap:wrap;
    }
    .tool-btn{
      font-size:1em;
      color:#1976d2;
      background:#e3f2fd;
      border:none;
      border-radius:10px;
      padding:10px 18px;
      cursor:pointer;
      font-weight:700;
      box-shadow:0 1px 1.5px rgba(33,150,243,0.08);
      transition: background 0.2s;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tool-btn:hover{ background:#bbdefb; }

    /* ===== Summary collapsed box ===== */
    .summary-wrap{ margin:0 0 10px 0; }
    .summary-box{
      display:none;
      color:#546e7a;
      font-size:0.95em;
      font-weight:700;
      background:#f6fbff;
      border-left:4px solid #90caf9;
      border-radius:10px;
      padding:10px 12px;
      margin-top:8px;
    }
    .summary-box b{ color:#455a64; }

    /* ===== Question main ===== */
    .question-main{ font-size:1em; margin-bottom:18px; font-weight:400; }
    .question-main p{ margin:0 0 10px 0; }
    .question-main p:last-child{ margin-bottom:0; }

    /* ===== Table style like screenshot ===== */
    .qtable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin:14px 0 16px 0;
      border:1px solid #cfcfcf;
      border-radius:10px;
      overflow:hidden;
      background:#fff;
      table-layout:fixed;
    }
    .qtable th, .qtable td{
      border-right:1px solid #cfcfcf;
      border-bottom:1px solid #cfcfcf;
      padding:10px 12px;
      text-align:center;
      vertical-align:middle;
      word-wrap:break-word;
    }
    .qtable th{
      background:#f3f3f3;
      font-weight:800;
      color:#333;
    }
    .qtable tr:last-child td{ border-bottom:none; }
    .qtable th:last-child, .qtable td:last-child{ border-right:none; }

    /* ===== Answers ===== */
    .answers{ margin-bottom:20px; }
    .answer-label{
      display:block;
      margin-bottom:13px;
      font-size:1em;
      font-weight:400;
      padding:6px 8px;
      border-radius:6px;
    }
    .answer-label input[type="radio"], .answer-label input[type="checkbox"] { margin-right:10px; }

    .answer-row{ display:flex; align-items:center; margin-top:14px; margin-bottom:15px; gap:30px; flex-wrap:wrap; }
    .answer-btn{
      background:#1976d2; color:#fff; border:none; border-radius:7px; font-size:1em; font-weight:600;
      padding:8px 26px; cursor:pointer; transition:background 0.2s; display:inline-block;
    }
    .answer-btn:hover{ background:#0d47a1; }

    .toggle-explanation-link{
      color:#1976d2; background:none; border:none; font-size:1em; font-weight:bold;
      cursor:pointer; text-decoration:underline; margin-left:6px;
    }
    .toggle-explanation-link:hover{ color:#0d47a1; }

    .status{
      font-weight:bold; display:inline-block; margin-left:18px; padding:2px 18px;
      border-radius:18px; font-size:1em;
    }
    .correct{ background:#388e3c; color:#fff; }
    .incorrect{ background:#fbc02d; color:#000; }

    .explanation{
      background:#fffde7; border-left:4px solid #fbc02d;
      padding:11px 14px; margin-top:12px; font-size:0.98em;
    }
    .correct-answer{ color:#388e3c; font-weight:bold; }
    .reference{
      color:#6a1b9a; background:#ede7f6; display:inline-block; border-radius:6px;
      padding:3px 10px; font-size:0.95em; margin-bottom:8px; margin-top:4px;
    }
    .explanation-en{ font-style:italic; color:#1976d2; margin-bottom:8px; margin-top:6px; }
    .explanation-vi{ color:#222; margin-bottom:5px; }

    /* highlight rules */
    .highlight-selected{ background:#fffde7; font-weight:bold; }
    .highlight-incorrect{ background:#fffde7; font-weight:bold; }
    .highlight-correct{ background:#c8e6c9; font-weight:bold; }
    .highlight-correct input{
      outline:2px solid #2e7d32;
      outline-offset:2px;
      border-radius:3px;
    }

    /* Clear button */
    #clear-answer-row{ display:flex; justify-content:center; margin:16px 0 0 0; }
    #clear-answer{
      background:#ffe082; color:#444; border:none; border-radius:8px;
      font-size:1em; font-weight:600; padding:8px 18px 8px 14px;
      cursor:pointer; box-shadow:0 2px 6px rgba(255,193,7,0.11);
      display:flex; align-items:center; gap:7px; transition: background 0.2s;
    }
    #clear-answer:hover{ background:#ffd54f; color:#222; }
    #clear-icon{ font-size:1.2em; }

    /* Paging */
    .action-buttons-row{ display:flex; align-items:center; justify-content:space-between; margin-top:18px; gap:12px; flex-wrap:wrap; }
    .pagination-controls{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .pagination-page{ font-size:1em; font-weight:bold; color:#1976d2; min-width:70px; text-align:center; }

    .nav-btn, .first-btn, .last-btn{
      padding:7px 14px; font-size:1em; border-radius:5px; border:none; font-weight:600;
      cursor:pointer; min-width:36px; margin-right:4px;
    }
    .nav-btn{ background:#616161; color:#fff; }
    .first-btn, .last-btn{ background:#2196f3; color:#fff; }
    .nav-btn:disabled, .first-btn:disabled, .last-btn:disabled{ background:#bbb; color:#fff; }

    .jump-wrap{ display:flex; align-items:center; gap:6px; margin-left:6px; }
    .jump-input{
      width:90px; padding:7px 10px; border:1px solid #cfcfcf; border-radius:6px; font-size:1em;
    }
    .jump-btn{
      padding:7px 12px; border:none; border-radius:6px; font-weight:700; cursor:pointer;
      background:#1976d2; color:#fff;
    }
    .jump-btn:hover{ background:#0d47a1; }

    .list-btn{
      background:#388e3c; color:#fff; padding:8px 24px; border:none; border-radius:5px;
      font-size:1em; font-weight:600; cursor:pointer; margin-right:8px;
    }
    .end-btn{
      background:#d32f2f; color:#fff; padding:8px 24px; border:none; border-radius:5px;
      font-size:1em; font-weight:600; cursor:pointer;
    }

    @media (max-width: 950px) {
      .container{ max-width:99vw; padding:2vw; }
      #timer-controls{ max-width:95vw; }
      .jump-wrap{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="container" id="main-container">
    <div class="icon-main">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="28" stroke="#1976d2" stroke-width="4" fill="#e3f2fd"/>
        <text x="32" y="41" text-anchor="middle" font-size="32" fill="#1976d2" font-family="Arial" font-weight="bold">?</text>
      </svg>
      <span>üìö</span>
    </div>
    <div class="title">RMP MOCK TEST</div>

    <!-- TIMER -->
    <div id="timer-controls">
      <span id="timer-sandglass">‚è≥</span>
      <label>
        <input type="number" id="minutes" min="0" max="99" value="1"> ph√∫t
        <input type="number" id="seconds" min="0" max="59" value="0"> gi√¢y
      </label>
      <button id="start-timer" type="button">Start</button>
      <button id="reset-timer" type="button">Reset</button>
      <span id="timer-display">01:00</span>
    </div>

    <div class="question-header-row">
      <span class="question-big" id="question-number"></span>
      <span class="level-tag" id="question-level"></span>
    </div>

    <!-- Summary + Hint -->
    <div class="top-tools-row">
      <button class="tool-btn" id="summary-toggle" type="button">+ Show summary</button>
      <button class="tool-btn" id="hint-btn" type="button">HINT: Ask ChatGPT</button>
    </div>

    <div class="summary-wrap">
      <div class="summary-box" id="question-summary"></div>
    </div>

    <div class="question-main" id="question-main"></div>

    <form id="answers" class="answers"></form>

    <div class="answer-row">
      <button class="answer-btn" id="answer-btn" type="button">ANSWER</button>
      <button class="toggle-explanation-link" id="toggle-explanation" type="button">+ Show answer & explanation</button>
      <span id="status" class="status"></span>
    </div>

    <div id="explanation" class="explanation" style="display:none;"></div>

    <div id="clear-answer-row">
      <button id="clear-answer" type="button">
        <span id="clear-icon">üßπ</span>
        Clear/Reset Answer
      </button>
    </div>

    <div class="action-buttons-row">
      <div class="pagination-controls">
        <button class="first-btn" id="btn-first" type="button">&laquo;</button>
        <button class="nav-btn" id="btn-prev" type="button">&lt;</button>
        <span class="pagination-page" id="page-label"></span>
        <button class="nav-btn" id="btn-next" type="button">&gt;</button>
        <button class="last-btn" id="btn-last" type="button">&raquo;</button>

        <div class="jump-wrap">
          <input id="jump-input" class="jump-input" type="number" min="1" step="1" placeholder="Go #">
          <button id="jump-btn" class="jump-btn" type="button">Go</button>
        </div>
      </div>

      <div>
        <button class="list-btn" id="btn-list" type="button">Back to list</button>
        <button class="end-btn" id="btn-end" type="button">End</button>
      </div>
    </div>
  </div>

  <script>
    /**************** TIMER ****************/
    let timerInterval = null;
    let remainingTime = 60;
    let timerIsActive = false;

    function displayTimer(sec) {
      let m = Math.floor(sec/60).toString().padStart(2,'0');
      let s = (sec%60).toString().padStart(2,'0');
      document.getElementById('timer-display').textContent = `${m}:${s}`;
    }
    function startCountdown() {
      let m = parseInt(document.getElementById('minutes').value) || 0;
      let s = parseInt(document.getElementById('seconds').value) || 0;
      remainingTime = m*60 + s;
      if (remainingTime <= 0) return;
      if (timerIsActive) clearInterval(timerInterval);
      displayTimer(remainingTime);
      timerIsActive = true;
      timerInterval = setInterval(()=>{
        remainingTime--;
        displayTimer(remainingTime);
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          timerIsActive = false;
          alert('H·∫æT GI·ªú!');
        }
      },1000);
    }
    function resetTimer() {
      clearInterval(timerInterval);
      timerIsActive = false;
      let m = parseInt(document.getElementById('minutes').value) || 0;
      let s = parseInt(document.getElementById('seconds').value) || 0;
      remainingTime = m*60 + s;
      displayTimer(remainingTime);
    }
    document.getElementById('start-timer').onclick = startCountdown;
    document.getElementById('reset-timer').onclick = resetTimer;
    window.addEventListener('DOMContentLoaded', resetTimer);

    /**************** STATE ****************/
    let questions = [];
    let current = 0;
    let userAnswers = [];
    let checked = [];
    let showExplanation = [];
    let showSummary = [];

    // Arrow double-press
    let lastArrowKey = null;
    let lastArrowTs = 0;
    const DOUBLE_MS = 450;

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function levelTag(level) {
      let txt = level || "Moderate";
      let className = "level-" + txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase();
      return `<span class="level-tag ${className}">${escapeHtml(txt)}</span>`;
    }

    function getMultiCount(text, options) {
      let lower = (text || "").toLowerCase();
      let m = lower.match(/choose\s+(two|three|four|five|\d+|all)/) ||
              lower.match(/select\s+(two|three|four|five|\d+|all)/) ||
              lower.match(/(pick|mark)\s+(two|three|four|five|\d+|all)/);
      if (m) {
        let val = m[1] || m[2];
        if (val === "two") return 2;
        if (val === "three") return 3;
        if (val === "four") return 4;
        if (val === "five") return 5;
        if (val === "all") return options ? options.length : 2;
        if (!isNaN(val)) return Number(val);
      }
      return 1;
    }

    function normalizeCorrectMulti(correct) {
      if (Array.isArray(correct)) return correct.map(Number);
      if (typeof correct === "number") return [correct];
      return [Number(correct)];
    }
    function normalizeCorrectSingle(correct) {
      if (Array.isArray(correct)) return Number(correct[0]);
      return Number(correct);
    }

    /**************** TABLE PARSER ****************/
    function isPipeTableLine(line) {
      if (!line) return false;
      const pipes = (line.match(/\|/g) || []).length;
      return pipes >= 2 && line.trim().length > 0;
    }

    function parsePipeRow(line) {
      // Keep empty first column if line starts with |
      let raw = line.trim();
      if (raw.startsWith("|")) raw = raw.slice(1);
      if (raw.endsWith("|")) raw = raw.slice(0, -1);
      return raw.split("|").map(c => c.trim());
    }

    function buildTableHTML(rows) {
      if (!rows || !rows.length) return "";
      const colCount = Math.max(...rows.map(r => r.length));
      const norm = rows.map(r => {
        const rr = r.slice();
        while (rr.length < colCount) rr.push("");
        return rr;
      });

      const header = norm[0];
      const body = norm.slice(1);

      let thead = "<thead><tr>";
      header.forEach(h => { thead += `<th>${escapeHtml(h)}</th>`; });
      thead += "</tr></thead>";

      let tbody = "<tbody>";
      body.forEach(r => {
        tbody += "<tr>";
        r.forEach(c => { tbody += `<td>${escapeHtml(c)}</td>`; });
        tbody += "</tr>";
      });
      tbody += "</tbody>";

      return `<table class="qtable">${thead}${tbody}</table>`;
    }

    function renderQuestionBodyWithTables(rawText) {
      let text = (rawText || "").replace(/\r\n/g, "\n");
      let lines = text.split("\n");

      // remove leading "Question" line (if any)
      const firstNonEmpty = lines.findIndex(l => l.trim().length > 0);
      if (firstNonEmpty >= 0 && lines[firstNonEmpty].trim().toLowerCase() === "question") {
        lines.splice(firstNonEmpty, 1);
      }

      let html = "";
      let buf = [];
      let i = 0;

      function flushParagraph() {
        const joined = buf.join("\n").trim();
        buf = [];
        if (!joined) return;
        // avoid huge vertical gaps
        const safe = escapeHtml(joined)
          .replace(/\n{3,}/g, "\n\n")
          .replace(/\n/g, "<br>");
        html += `<p>${safe}</p>`;
      }

      while (i < lines.length) {
        const line = lines[i];

        // Table block: consecutive lines with pipes
        if (isPipeTableLine(line)) {
          flushParagraph();
          const rows = [];
          while (i < lines.length && isPipeTableLine(lines[i])) {
            rows.push(parsePipeRow(lines[i]));
            i++;
          }
          html += buildTableHTML(rows);
          continue;
        }

        // normal line
        if (line.trim() === "") {
          // keep at most one empty line in paragraph
          if (buf.length && buf[buf.length - 1].trim() !== "") buf.push("");
        } else {
          buf.push(line);
        }
        i++;
      }
      flushParagraph();
      return html;
    }

    /**************** RENDER ****************/
    function clearHighlights(q) {
      if(!q || !q.options) return;
      for (let i = 0; i < q.options.length; i++) {
        const lbl = document.getElementById("label"+i);
        if(lbl) lbl.classList.remove("highlight-correct","highlight-incorrect","highlight-selected");
      }
    }

    function renderQuestion() {
      const q = questions[current];
      const multiCount = getMultiCount(q.question, q.options);

      document.getElementById("question-number").textContent = `Question#${current+1}`;
      document.getElementById("question-level").innerHTML = levelTag(q.difficulty);

      // Summary
      const summaryBox = document.getElementById("question-summary");
      summaryBox.innerHTML = `<b>Summary:</b> ${escapeHtml(q.short || "")}`;
      summaryBox.style.display = showSummary[current] ? "block" : "none";
      document.getElementById("summary-toggle").textContent = showSummary[current] ? "- Hide summary" : "+ Show summary";

      // Question body with table rendering
      document.getElementById("question-main").innerHTML = renderQuestionBodyWithTables(q.question);

      // Answers render
      let ansHtml = "";
      if (multiCount > 1) {
        const arr = Array.isArray(userAnswers[current]) ? userAnswers[current].map(Number) : [];
        q.options.forEach((option, i) => {
          ansHtml += `<label class="answer-label" id="label${i}">
            <input type="checkbox" name="q${current}" value="${i}"
              ${arr.includes(i) ? "checked" : ""} ${checked[current] ? "disabled" : ""}
              onchange="updateMultiAnswer(${i})">
            ${String.fromCharCode(65+i)}. ${escapeHtml(option)}
          </label>`;
        });
      } else {
        q.options.forEach((option, i) => {
          ansHtml += `<label class="answer-label" id="label${i}">
            <input type="radio" name="q${current}" value="${i}"
              ${(userAnswers[current] == i) ? "checked" : ""} ${checked[current] ? "disabled" : ""}
              onchange="updateSingleAnswer(${i})">
            ${String.fromCharCode(65+i)}. ${escapeHtml(option)}
          </label>`;
        });
      }
      document.getElementById("answers").innerHTML = ansHtml;

      // Reset status + explanation
      document.getElementById("status").textContent = "";
      document.getElementById("status").className = "status";
      document.getElementById("toggle-explanation").innerHTML = "+ Show answer & explanation";
      document.getElementById("explanation").style.display = showExplanation[current] ? "block" : "none";

      // Explanation content (fix weird " ä." issue by not injecting unexpected chars)
      let expHtml = "";
      if (multiCount > 1) {
        const corr = normalizeCorrectMulti(q.correct);
        expHtml = `<span class="correct-hint">ƒê√°p √°n ƒë√∫ng</span>: <span class="correct-answer">${
          corr.map(idx => `${String.fromCharCode(65+idx)}. ${escapeHtml(q.options[idx])}`).join(", ")
        }</span><br>`;
      } else {
        const c = normalizeCorrectSingle(q.correct);
        expHtml = `<span class="correct-hint">ƒê√°p √°n ƒë√∫ng</span>: <span class="correct-answer">${String.fromCharCode(65+c)}. ${escapeHtml(q.options[c])}</span><br>`;
      }
      if (q.reference) expHtml += `<span class="reference">Tham kh·∫£o: ${escapeHtml(q.reference).replace(/\n/g,"<br>")}</span><br>`;
      if (q.explanation_en) expHtml += `<div class="explanation-en">Gi·∫£i th√≠ch EN: ${escapeHtml(q.explanation_en).replace(/\n/g,"<br>")}</div>`;
      if (q.explanation_vi) expHtml += `<div class="explanation-vi">Gi·∫£i th√≠ch Vi: ${escapeHtml(q.explanation_vi).replace(/\n/g,"<br>")}</div>`;
      document.getElementById("explanation").innerHTML = expHtml;

      // Paging
      document.getElementById("page-label").textContent = `${current+1} / ${questions.length}`;
      document.getElementById("btn-first").disabled = current===0;
      document.getElementById("btn-prev").disabled = current===0;
      document.getElementById("btn-next").disabled = current===questions.length-1;
      document.getElementById("btn-last").disabled = current===questions.length-1;

      // Jump bounds
      const ji = document.getElementById("jump-input");
      ji.max = String(questions.length);

      // save current
      localStorage.setItem("rmp_current_idx", String(current));

      // if already checked
      if (checked[current]) showCheckResult();
    }

    /**************** ANSWER UPDATE ****************/
    window.updateSingleAnswer = function(i) {
      userAnswers[current] = Number(i);
      localStorage.setItem("rmp_userAnswers", JSON.stringify(userAnswers));
    };

    window.updateMultiAnswer = function(i) {
      i = Number(i);
      let arr = Array.isArray(userAnswers[current]) ? userAnswers[current].map(Number) : [];
      const checkbox = document.querySelector(`input[type=checkbox][name="q${current}"][value="${i}"]`);
      if (checkbox && checkbox.checked) {
        if (!arr.includes(i)) arr.push(i);
      } else {
        arr = arr.filter(x => x !== i);
      }
      userAnswers[current] = arr;
      localStorage.setItem("rmp_userAnswers", JSON.stringify(userAnswers));

      // limit tick count
      const q = questions[current];
      const multiCount = getMultiCount(q.question, q.options);
      const boxes = document.querySelectorAll(`input[type=checkbox][name="q${current}"]`);
      boxes.forEach(box => {
        const v = Number(box.value);
        if (!arr.includes(v) && arr.length >= multiCount) box.disabled = true;
        else box.disabled = false;
      });
    };

    function showCheckResult() {
      const q = questions[current];
      const multiCount = getMultiCount(q.question, q.options);
      const status = document.getElementById("status");

      clearHighlights(q);

      let correctArr, chosenArr, isCorrect = false;

      if (multiCount > 1) {
        correctArr = normalizeCorrectMulti(q.correct);
        chosenArr = Array.isArray(userAnswers[current]) ? userAnswers[current].map(Number) : [];
        isCorrect = (chosenArr.length === correctArr.length) && correctArr.every(idx => chosenArr.includes(idx));
      } else {
        const c = normalizeCorrectSingle(q.correct);
        const chosen = Number(userAnswers[current]);
        correctArr = [c];
        chosenArr = [chosen];
        isCorrect = (chosen === c);
      }

      if (isCorrect) {
        status.textContent = "CORRECT";
        status.className = "status correct";
        // keep selected yellow only
        chosenArr.forEach(idx => {
          if (idx == null || Number.isNaN(idx)) return;
          const lbl = document.getElementById("label"+idx);
          if (lbl) lbl.classList.add("highlight-selected");
        });
      } else {
        status.textContent = "INCORRECT";
        status.className = "status incorrect";
        chosenArr.forEach(idx => {
          if (idx == null || Number.isNaN(idx)) return;
          const lbl = document.getElementById("label"+idx);
          if (lbl) lbl.classList.add("highlight-incorrect");
        });
        correctArr.forEach(idx => {
          const lbl = document.getElementById("label"+idx);
          if (lbl) lbl.classList.add("highlight-correct");
        });
      }

      // disable inputs
      document.querySelectorAll(".answers input").forEach(inp => inp.disabled = true);
    }

    /**************** BUTTONS ****************/
    document.getElementById("answer-btn").onclick = function() {
      const q = questions[current];
      const multiCount = getMultiCount(q.question, q.options);

      if (checked[current]) return;

      const status = document.getElementById("status");

      if (multiCount > 1) {
        const boxes = document.querySelectorAll(`input[type=checkbox][name="q${current}"]`);
        const arr = [];
        boxes.forEach(b => { if (b.checked) arr.push(Number(b.value)); });
        if (arr.length < multiCount) {
          status.textContent = `Please choose ${multiCount} answers!`;
          status.className = "status";
          return;
        }
        userAnswers[current] = arr;
      } else {
        const radios = document.getElementsByName("q"+current);
        let chosen = null;
        for (let i=0;i<radios.length;i++){
          if (radios[i].checked){ chosen = Number(radios[i].value); break; }
        }
        if (chosen === null) {
          status.textContent = "Please choose an answer!";
          status.className = "status";
          return;
        }
        userAnswers[current] = chosen;
      }

      checked[current] = true;
      localStorage.setItem("rmp_userAnswers", JSON.stringify(userAnswers));
      localStorage.setItem("rmp_checked", JSON.stringify(checked));
      showCheckResult();
    };

    document.getElementById("toggle-explanation").onclick = function() {
      showExplanation[current] = !showExplanation[current];
      document.getElementById("explanation").style.display = showExplanation[current] ? "block" : "none";
      this.innerHTML = showExplanation[current] ? "- Hide answer & explanation" : "+ Show answer & explanation";
    };

    document.getElementById("summary-toggle").onclick = function() {
      showSummary[current] = !showSummary[current];
      document.getElementById("question-summary").style.display = showSummary[current] ? "block" : "none";
      this.textContent = showSummary[current] ? "- Hide summary" : "+ Show summary";
      localStorage.setItem("rmp_showSummary", JSON.stringify(showSummary));
    };

    document.getElementById("hint-btn").onclick = function() {
      const q = questions[current];
      const prompt = `Ph√¢n t√≠ch c√¢u h·ªèi RMP sau, gi·∫£i th√≠ch chi ti·∫øt b·∫±ng ti·∫øng Vi·ªát v√† l√Ω do ch·ªçn, kh√¥ng ch·ªçn t·ª´ng ƒë√°p √°n.\n\nC√¢u h·ªèi:\n${q.question}\n\nC√°c ƒë√°p √°n:\n${q.options.map((opt, i)=>String.fromCharCode(65+i)+'. '+opt).join('\n')}`;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(prompt).then(function() {
          window.open("https://chat.openai.com/", "_blank");
          alert("Prompt ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard. H√£y d√°n (Ctrl+V) v√†o √¥ chat ChatGPT!");
        }, function() {
          alert("Kh√¥ng copy ƒë∆∞·ª£c prompt, h√£y t·ª± copy:\n\n" + prompt);
          window.open("https://chat.openai.com/", "_blank");
        });
      } else {
        alert("H√£y t·ª± copy prompt sau v√† d√°n v√†o ChatGPT:\n\n" + prompt);
        window.open("https://chat.openai.com/", "_blank");
      }
    };

    document.getElementById("clear-answer").onclick = function() {
      document.querySelectorAll(`input[name="q${current}"]`).forEach(el => {
        el.checked = false;
        el.disabled = false;
      });

      const q = questions[current];
      userAnswers[current] = (getMultiCount(q.question, q.options) > 1) ? [] : null;
      checked[current] = false;
      showExplanation[current] = false;

      localStorage.setItem("rmp_userAnswers", JSON.stringify(userAnswers));
      localStorage.setItem("rmp_checked", JSON.stringify(checked));

      document.getElementById("status").textContent = "";
      document.getElementById("status").className = "status";
      document.getElementById("toggle-explanation").innerHTML = "+ Show answer & explanation";
      document.getElementById("explanation").style.display = "none";

      clearHighlights(q);
    };

    function goTo(idx) {
      if (idx < 0) idx = 0;
      if (idx > questions.length - 1) idx = questions.length - 1;
      current = idx;
      renderQuestion();
    }

    document.getElementById("btn-first").onclick = () => goTo(0);
    document.getElementById("btn-prev").onclick  = () => goTo(current-1);
    document.getElementById("btn-next").onclick  = () => goTo(current+1);
    document.getElementById("btn-last").onclick  = () => goTo(questions.length-1);

    function doJump() {
      let n = parseInt(document.getElementById("jump-input").value, 10);
      if (Number.isNaN(n)) return;
      if (n < 1) n = 1;
      if (n > questions.length) n = questions.length;
      goTo(n-1);
      document.getElementById("jump-input").value = "";
    }
    document.getElementById("jump-btn").onclick = doJump;
    document.getElementById("jump-input").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); doJump(); }
    });

    document.getElementById("btn-list").onclick = () => window.location.href = "questionsList.html";
    document.getElementById("btn-end").onclick = function() {
      localStorage.setItem("rmp_userAnswers", JSON.stringify(userAnswers));
      localStorage.setItem("rmp_checked", JSON.stringify(checked));
      window.location.href = "result.html";
    };

    // Keyboard arrows (double press -> first/last)
    window.addEventListener("keydown", (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if (tag === "input" || tag === "textarea") return;

      if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
        const now = Date.now();
        const isDouble = (lastArrowKey === e.key) && (now - lastArrowTs <= DOUBLE_MS);
        lastArrowKey = e.key;
        lastArrowTs = now;

        if (e.key === "ArrowLeft") {
          if (isDouble) goTo(0);
          else goTo(current - 1);
        } else {
          if (isDouble) goTo(questions.length - 1);
          else goTo(current + 1);
        }
      }
    });

    /**************** LOAD ****************/
    window.onload = function() {
      // IMPORTANT: only RMP keys (but keep fallback to pmp if b·∫°n c√≤n data c≈©)
      let raw = localStorage.getItem("rmp_questions") || localStorage.getItem("pmp_questions");
      if (!raw) { window.location.href = "index.html"; return; }

      questions = JSON.parse(raw);

      userAnswers = JSON.parse(localStorage.getItem("rmp_userAnswers") || localStorage.getItem("pmp_userAnswers") || "null")
        || Array(questions.length).fill(null);

      checked = JSON.parse(localStorage.getItem("rmp_checked") || localStorage.getItem("pmp_checked") || "null")
        || Array(questions.length).fill(false);

      showExplanation = Array(questions.length).fill(false);

      showSummary = JSON.parse(localStorage.getItem("rmp_showSummary") || "null")
        || Array(questions.length).fill(false);

      current = parseInt(localStorage.getItem("rmp_current_idx") || "0", 10);
      if (Number.isNaN(current) || current < 0) current = 0;
      if (current > questions.length - 1) current = questions.length - 1;

      renderQuestion();
    };
  </script>
</body>
</html>
